<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header border-bottom bg-light">
        <h5 class="mb-0"><i class="bi bi-person-plus me-2"></i>Registrar Personal</h5>
      </div>

      <div class="card-body p-4">
        <!-- Mensajes de éxito/error -->
        <% if (error) { %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <%= error %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% } %>

        <% if (success) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            <%= success %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% } %>

        <form method="post" action="/personal" enctype="multipart/form-data" accept-charset="UTF-8" class="needs-validation" novalidate id="registroForm">
          <!-- Sección: Información Personal -->
          <h6 class="mb-3 text-uppercase text-muted fw-semibold">
            <i class="bi bi-person me-2"></i>Información Personal
          </h6>
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label">Cédula de Identidad <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="ci" value="<%= formData?.ci || '' %>" required pattern="^[0-9]{7,8}[A-Z]?$" title="Formato: 7-8 dígitos + letra opcional" placeholder="Ej: 12345678 o 12345678A" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Rol <span class="text-danger">*</span></label>
              <select class="form-select" id="idRol" name="id_rol" value="<%= formData?.id_rol || '' %>" onchange="actualizarEspecialidades()" required>
                <option value="">-- Seleccionar rol --</option>
                <% if (roles && roles.length > 0) { %>
                  <% roles.forEach(rol => { %>
                    <option value="<%= rol.id_rol %>" <%= formData?.id_rol === rol.id_rol.toString() ? 'selected' : '' %>><%= rol.nombre_rol %></option>
                  <% }); %>
                <% } else { %>
                  <option value="0fe2336b-d854-11f0-9531-40c2ba62ef61">Admin</option>
                  <option value="0fe2393a-d854-11f0-9531-40c2ba62ef61">Ventanilla</option>
                  <option value="0fe23b2d-d854-11f0-9531-40c2ba62ef61">Médico</option>
                <% } %>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Nombres <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="nombres" value="<%= formData?.nombres || '' %>" required pattern="^[a-zA-ZáéíóúñÁÉÍÓÚÑ\s]+$" title="Solo letras y espacios" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Apellido Paterno <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="apellido_paterno" value="<%= formData?.apellido_paterno || '' %>" required pattern="^[a-zA-ZáéíóúñÁÉÍÓÚÑ\s]+$" title="Solo letras y espacios" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Apellido Materno</label>
              <input type="text" class="form-control" name="apellido_materno" value="<%= formData?.apellido_materno || '' %>" pattern="^[a-zA-ZáéíóúñÁÉÍÓÚÑ\s]*$" title="Solo letras y espacios" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Cargo</label>
              <input type="text" class="form-control" name="cargo" value="<%= formData?.cargo || '' %>" />
            </div>
          </div>

          <hr />

          <!-- Sección: Contacto -->
          <h6 class="mb-3 text-uppercase text-muted fw-semibold">
            <i class="bi bi-telephone me-2"></i>Información de Contacto
          </h6>
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label">Correo Electrónico</label>
              <input type="email" class="form-control" name="correo" value="<%= formData?.correo || '' %>" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Teléfono <span class="text-danger">*</span></label>
              <input type="tel" class="form-control" name="celular" value="<%= formData?.celular || '' %>" required placeholder="Ej: +591 70 123456 o 70123456" />
            </div>
            <div class="col-12">
              <label class="form-label">Domicilio</label>
              <input type="text" class="form-control" name="domicilio" value="<%= formData?.domicilio || '' %>" />
            </div>
          </div>

          <hr />

          <!-- Sección: Datos Laborales -->
          <h6 class="mb-3 text-uppercase text-muted fw-semibold">
            <i class="bi bi-briefcase me-2"></i>Datos Laborales
          </h6>
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label">Fecha de Nacimiento <span class="text-danger">*</span></label>
              <input type="date" class="form-control" name="fecha_nacimiento" value="<%= formData?.fecha_nacimiento || '' %>" required />
              <small class="form-text text-muted">Debe ser mayor de 18 años</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Fecha de Contratación <span class="text-danger">*</span></label>
              <input type="date" class="form-control" name="fecha_contratacion" value="<%= formData?.fecha_contratacion || '' %>" required />
            </div>
          </div>

          <hr />

          <!-- Sección: Especialidades (solo para médicos) -->
          <div id="seccionEspecialidades" style="display: none;">
            <h6 class="mb-3 text-uppercase text-muted fw-semibold">
              <i class="bi bi-hospital me-2"></i>Especialidades <span class="text-danger">*</span>
            </h6>
            <div class="row g-3 mb-4">
              <div class="col-12">
                <label class="form-label">Selecciona al menos una especialidad</label>
                <div class="row" id="especialidadesContainer">
                  <% if (especialidades && especialidades.length > 0) { %>
                    <% especialidades.forEach(esp => { %>
                      <div class="col-md-6 col-lg-4">
                        <div class="form-check">
                          <input 
                            class="form-check-input" 
                            type="checkbox" 
                            name="especialidades" 
                            value="<%= esp.id_especialidad %>" 
                            id="esp_<%= esp.id_especialidad %>"
                            <% if (formData?.especialidades && (Array.isArray(formData.especialidades) ? formData.especialidades.includes(esp.id_especialidad.toString()) : formData.especialidades === esp.id_especialidad.toString())) { %> checked <% } %>
                          />
                          <label class="form-check-label" for="esp_<%= esp.id_especialidad %>">
                            <%= esp.nombre %>
                          </label>
                        </div>
                      </div>
                    <% }); %>
                  <% } else { %>
                    <div class="col-12">
                      <small class="text-muted"><em>No hay especialidades disponibles</em></small>
                    </div>
                  <% } %>
                </div>
                <small class="text-muted d-block mt-2">
                  <i class="bi bi-info-circle me-1"></i>Un médico debe tener al menos una especialidad
                </small>
              </div>
            </div>
          </div>

          <hr />

          <!-- Sección: Credenciales de Acceso -->
          <h6 class="mb-3 text-uppercase text-muted fw-semibold">
            <i class="bi bi-shield-lock me-2"></i>Credenciales de Acceso
          </h6>
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label">Contraseña <span class="text-danger">*</span></label>
              <input type="password" class="form-control" name="contrasena" required />
              <small class="text-muted">Mínimo 6 caracteres</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Confirmar Contraseña <span class="text-danger">*</span></label>
              <input type="password" class="form-control" name="contrasena_confirm" required />
            </div>
          </div>

          <hr />

          <!-- Sección: Archivos -->
          <h6 class="mb-3 text-uppercase text-muted fw-semibold">
            <i class="bi bi-file-earmark me-2"></i>Documentos
          </h6>
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label">Foto de Perfil</label>
              <input type="file" class="form-control" name="foto_perfil" accept="image/jpeg,image/png" />
              <small class="text-muted">JPG, PNG (máx. 5MB)</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Archivo de Contrato</label>
              <input type="file" class="form-control" name="archivo_contrato" accept="application/pdf" />
              <small class="text-muted">PDF (máx. 10MB)</small>
            </div>
          </div>

          <!-- Botones -->
          <div class="mt-4">
            <button type="submit" class="btn btn-primary me-2">
              <i class="bi bi-check-lg me-1"></i>Registrar Personal
            </button>
            <a href="/dashboard" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-1"></i>Cancelar
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // ID del rol médico (será dinámico desde la BD)
  const ROLE_MEDICO = '<%= roles.find(r => r.nombre_rol === "medico")?.id_rol || "0fe23b2d-d854-11f0-9531-40c2ba62ef61" %>';

  function actualizarEspecialidades() {
    const idRol = document.getElementById('idRol').value;
    const seccion = document.getElementById('seccionEspecialidades');
    
    if (idRol === ROLE_MEDICO) {
      seccion.style.display = 'block';
    } else {
      seccion.style.display = 'none';
      // Desmarcar todas las especialidades si no es médico
      document.querySelectorAll('input[name="especialidades"]').forEach(cb => cb.checked = false);
    }
  }

  // Validar al submit
  document.getElementById('registroForm').addEventListener('submit', function(e) {
    const idRol = document.getElementById('idRol').value;
    
    if (idRol === ROLE_MEDICO) {
      const checkboxes = document.querySelectorAll('input[name="especialidades"]:checked');
      if (checkboxes.length === 0) {
        e.preventDefault();
        alert('Debes seleccionar al menos una especialidad para un médico');
        return false;
      }
    }
  });

  // Ejecutar al cargar la página
  document.addEventListener('DOMContentLoaded', function() {
    actualizarEspecialidades();
  });
</script>
