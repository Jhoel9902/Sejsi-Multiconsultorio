<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header border-bottom bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Gestionar Personal</h5>
        <a href="/personal/registrar" class="btn btn-sm btn-primary">
          <i class="bi bi-plus-circle me-1"></i>Nuevo Personal
        </a>
      </div>

      <div class="card-body p-0">
        <% if (personal && personal.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Cédula</th>
                  <th>Nombre</th>
                  <th>Cargo</th>
                  <th>Rol</th>
                  <th>Correo</th>
                  <th>Teléfono</th>
                  <th>Estado</th>
                  <th class="text-center" style="width: 120px;">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <% personal.forEach(p => { %>
                  <tr>
                    <td>
                      <span class="fw-semibold"><%= p.ci %></span>
                    </td>
                    <td>
                      <%= p.nombres %> <%= p.apellido_paterno %>
                      <% if (p.apellido_materno) { %>
                        <%= p.apellido_materno %>
                      <% } %>
                    </td>
                    <td><%= p.cargo || '-' %></td>
                    <td>
                      <span class="badge" style="background: var(--primary-color); color: white;">
                        <%= p.nombre_rol || '-' %>
                      </span>
                    </td>
                    <td><small class="text-muted"><%= p.correo || '-' %></small></td>
                    <td><small><%= p.celular || '-' %></small></td>
                    <td>
                      <% if (p.estado) { %>
                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Activo</span>
                      <% } else { %>
                        <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Inactivo</span>
                      <% } %>
                    </td>
                    <td class="text-center">
                      <button 
                        type="button" 
                        class="btn btn-sm btn-outline-primary me-1"
                        onclick="abrirModalEditarPersonal('<%= p.id_personal %>')"
                        title="Editar"
                      >
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button 
                        type="button" 
                        class="btn btn-sm btn-outline-danger"
                        onclick="toggleEstadoPersonal('<%= p.id_personal %>', <%= p.estado %>)"
                        title="<%= p.estado ? 'Desactivar' : 'Activar' %>"
                      >
                        <i class="bi <%= p.estado ? 'bi-toggle-on' : 'bi-toggle-off' %>"></i>
                      </button>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="p-4 text-center text-muted">
            <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.5;"></i>
            <p class="mt-2">No hay personal registrado</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Modal para editar personal -->
<div class="modal fade" id="modalEditarPersonal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-bottom">
        <h5 class="modal-title">Editar Personal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="contenidoModalEditar">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function abrirModalEditarPersonal(id) {
    fetch(`/personal/obtener-formulario/${id}`)
      .then(r => r.text())
      .then(html => {
        document.getElementById('contenidoModalEditar').innerHTML = html;
        new bootstrap.Modal(document.getElementById('modalEditarPersonal')).show();
      })
      .catch(err => alert('Error al cargar el formulario'));
  }

  function enviarFormularioEditar(id) {
    const form = document.getElementById('formEditarPersonal');
    const formData = new FormData(form);

    fetch(`/personal/editar/${id}`, {
      method: 'POST',
      body: formData
    })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          alert('Personal actualizado exitosamente.');
          bootstrap.Modal.getInstance(document.getElementById('modalEditarPersonal')).hide();
          window.location.reload();
        } else {
          alert('Error: ' + (data.error || data.mensaje));
        }
      })
      .catch(err => alert('Error al actualizar personal'));
  }

  function toggleEstadoPersonal(id, estadoActual) {
    if (confirm(`¿Estás seguro de que deseas ${estadoActual ? 'desactivar' : 'activar'} este personal?`)) {
      // Pendiente: implementar SP para toggle estado
      alert('Funcionalidad próximamente...');
    }
  }
</script>
