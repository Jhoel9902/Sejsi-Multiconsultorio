<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="mb-4"><i class="bi bi-credit-card me-2"></i>M√≥dulo de Pagos</h2>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label fw-bold">Buscar por ID Cita</label>
            <input type="text" class="form-control" id="id_cita_busqueda" placeholder="Ingresa ID de cita">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="buscarFacturas()"><i class="bi bi-search me-2"></i>Buscar</button>
        </div>
    </div>

    <!-- Alertas -->
    <div id="alertas"></div>

    <!-- Tabla de Facturas -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-receipt me-2"></i>Facturas por Cita</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm" id="tabla-facturas">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 20%;">N√∫mero Factura</th>
                                    <th style="width: 15%;">Tipo</th>
                                    <th style="width: 15%;">Subtotal</th>
                                    <th style="width: 15%;">Total</th>
                                    <th style="width: 20%;">Fecha Emisi√≥n</th>
                                    <th style="width: 15%;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="facturas-tbody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="bi bi-search me-2"></i>Busca una cita para ver sus facturas
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalles Factura Cliente -->
<div class="modal fade" id="modalFacturaCliente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Factura Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="factura-cliente-content">
                <!-- Se llena din√°micamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" onclick="abrirModalPago()"><i class="bi bi-cash me-2"></i>Registrar Pago</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Registrar Pago -->
<div class="modal fade" id="modalRegistroPago" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>Registrar Pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">M√©todo de Pago</label>
                    <select class="form-select" id="metodo_pago">
                        <option value="">Seleccionar m√©todo...</option>
                        <option value="efectivo">üíµ Efectivo</option>
                        <option value="tarjeta_credito">üí≥ Tarjeta de Cr√©dito</option>
                        <option value="tarjeta_debito">üí≥ Tarjeta de D√©bito</option>
                        <option value="transferencia">üè¶ Transferencia Bancaria</option>
                        <option value="cheque">üìÑ Cheque</option>
                    </select>
                </div>
                <div class="alert alert-info" role="alert">
                    <small><i class="bi bi-info-circle me-2"></i>Confirma el m√©todo de pago para continuar</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmarPago()"><i class="bi bi-check-circle me-2"></i>Confirmar Pago</button>
            </div>
        </div>
    </div>
</div>

<script>
    let id_factura_actual = null;

    async function buscarFacturas() {
        const id_cita = document.getElementById('id_cita_busqueda').value.trim();

        if (!id_cita) {
            mostrarAlerta('Por favor ingresa un ID de cita', 'warning');
            return;
        }

        try {
            const response = await fetch(`/pagos/cita/${id_cita}`);
            const data = await response.json();

            if (!data.success) {
                mostrarAlerta(data.mensaje, 'warning');
                document.getElementById('facturas-tbody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="bi bi-exclamation-circle me-2"></i>No se encontraron facturas
                        </td>
                    </tr>
                `;
                return;
            }

            const facturas = data.facturas || [];
            const tbody = document.getElementById('facturas-tbody');
            tbody.innerHTML = '';

            if (facturas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="bi bi-inbox me-2"></i>Sin facturas
                        </td>
                    </tr>
                `;
                mostrarAlerta('No se encontraron facturas para esta cita', 'info');
                return;
            }

            facturas.forEach(factura => {
                const tipoBadge = factura.tipo_factura === 'cliente' 
                    ? '<span class="badge bg-info"><i class="bi bi-person me-1"></i>Cliente</span>' 
                    : '<span class="badge bg-warning text-dark"><i class="bi bi-hospital me-1"></i>Aseguradora</span>';

                const estadoBadge = factura.metodo_pago 
                    ? '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Pagado</span>'
                    : '<span class="badge bg-secondary">Pendiente</span>';

                const row = `
                    <tr>
                        <td><strong>${factura.numero_factura}</strong></td>
                        <td>${tipoBadge}</td>
                        <td>$${parseFloat(factura.subtotal).toFixed(2)}</td>
                        <td><strong>$${parseFloat(factura.total).toFixed(2)}</strong></td>
                        <td><small>${new Date(factura.fecha_emision).toLocaleDateString('es-ES')}</small></td>
                        <td>
                            ${factura.tipo_factura === 'cliente' 
                                ? `<button class="btn btn-sm btn-info me-2" onclick="verFacturaCliente('${factura.id_factura_cliente}')"><i class="bi bi-eye me-1"></i>Ver</button>` 
                                : '<button class="btn btn-sm btn-secondary me-2" disabled><i class="bi bi-eye me-1"></i>Ver</button>'}
                            ${estadoBadge}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            mostrarAlerta(`‚úì Se encontraron ${facturas.length} factura(s)`, 'success');
        } catch (error) {
            console.error('Error al buscar facturas:', error);
            mostrarAlerta('Error al buscar facturas', 'danger');
        }
    }

    async function verFacturaCliente(id_factura) {
        id_factura_actual = id_factura;

        try {
            const response = await fetch(`/pagos/factura-cliente/${id_factura}`);
            const data = await response.json();

            if (!data.success) {
                mostrarAlerta(data.mensaje, 'danger');
                return;
            }

            const factura = data.factura;
            const detalles = data.detalles || [];

            let detallesHtml = '';
            detalles.forEach(detalle => {
                const subtotal = detalle.cantidad * detalle.precio_unitario;
                detallesHtml += `
                    <tr>
                        <td>${detalle.cantidad}</td>
                        <td>$${parseFloat(detalle.precio_unitario).toFixed(2)}</td>
                        <td>$${parseFloat(subtotal).toFixed(2)}</td>
                    </tr>
                `;
            });

            const contenido = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>N√∫mero Factura:</strong> <code>${factura.numero_factura}</code></p>
                        <p><strong>Paciente ID:</strong> <code>${factura.id_paciente}</code></p>
                    </div>
                    <div class="col-md-6 text-end">
                        <p><strong>Fecha Emisi√≥n:</strong> ${new Date(factura.fecha_emision).toLocaleDateString('es-ES')}</p>
                        <p><strong>Estado:</strong> 
                            ${factura.estado === 1 
                                ? '<span class="badge bg-success">Activa</span>' 
                                : '<span class="badge bg-secondary">Inactiva</span>'}
                        </p>
                    </div>
                </div>

                <hr>

                <div class="mb-3">
                    <h6 class="fw-bold mb-2">Detalles de Factura</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Cantidad</th>
                                    <th>Unitario</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${detallesHtml}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6"></div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <strong>$${parseFloat(factura.subtotal).toFixed(2)}</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold">Total:</span>
                                    <strong class="fs-5 text-success">$${parseFloat(factura.total).toFixed(2)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                ${factura.metodo_pago ? `
                    <div class="alert alert-success mt-3" role="alert">
                        <i class="bi bi-check-circle me-2"></i><strong>‚úì Pagado</strong> 
                        <br><small>M√©todo: <strong>${factura.metodo_pago.toUpperCase().replace('_', ' ')}</strong></small>
                    </div>
                ` : ''}
            `;

            document.getElementById('factura-cliente-content').innerHTML = contenido;
            new bootstrap.Modal(document.getElementById('modalFacturaCliente')).show();
        } catch (error) {
            console.error('Error al obtener factura:', error);
            mostrarAlerta('Error al obtener factura', 'danger');
        }
    }

    function abrirModalPago() {
        bootstrap.Modal.getInstance(document.getElementById('modalFacturaCliente')).hide();
        new bootstrap.Modal(document.getElementById('modalRegistroPago')).show();
    }

    async function confirmarPago() {
        const metodo_pago = document.getElementById('metodo_pago').value;

        if (!metodo_pago) {
            mostrarAlerta('Por favor selecciona un m√©todo de pago', 'danger');
            return;
        }

        try {
            const response = await fetch('/pagos/registrar-pago', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id_factura_cliente: id_factura_actual,
                    metodo_pago
                })
            });

            const data = await response.json();

            if (!data.success) {
                mostrarAlerta(data.mensaje, 'danger');
                return;
            }

            bootstrap.Modal.getInstance(document.getElementById('modalRegistroPago')).hide();
            mostrarAlerta('‚úÖ Pago registrado exitosamente', 'success');
            
            // Refrescar b√∫squeda
            setTimeout(() => {
                buscarFacturas();
            }, 1500);
        } catch (error) {
            console.error('Error al registrar pago:', error);
            mostrarAlerta('Error al registrar pago', 'danger');
        }
    }

    function mostrarAlerta(mensaje, tipo = 'danger') {
        const alertasDiv = document.getElementById('alertas');
        alertasDiv.innerHTML = `
            <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                <i class="bi bi-${tipo === 'success' ? 'check-circle' : tipo === 'danger' ? 'exclamation-triangle' : tipo === 'warning' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
</script>
