<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-body p-4">
        <h5 class="card-title mb-4"><i class="bi bi-person-plus me-2"></i>Registrar nuevo paciente</h5>

        <% if (error) { %>
          <div class="alert alert-danger"><%= error %></div>
        <% } %>

        <form method="post" action="/pacientes" class="needs-validation" novalidate accept-charset="UTF-8">
          <div class="row g-3">
            <!-- Datos personales -->
            <h6 class="col-12 mt-3 text-muted">Datos personales</h6>
            
            <div class="col-md-6">
              <label class="form-label">Nombre <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="nombre" value="<%= formData?.nombre || '' %>" required pattern="^[a-zA-ZáéíóúñÁÉÍÓÚÑ\s]+$" title="Solo letras y espacios" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Apellido paterno <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="apellido_paterno" value="<%= formData?.apellido_paterno || '' %>" required pattern="^[a-zA-ZáéíóúñÁÉÍÓÚÑ\s]+$" title="Solo letras y espacios" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Apellido materno</label>
              <input type="text" class="form-control" name="apellido_materno" value="<%= formData?.apellido_materno || '' %>" pattern="^[a-zA-ZáéíóúñÁÉÍÓÚÑ\s]*$" title="Solo letras y espacios" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Fecha de nacimiento <span class="text-danger">*</span></label>
              <input type="date" class="form-control" name="fecha_nacimiento" value="<%= formData?.fecha_nacimiento || '' %>" required />
            </div>

            <!-- Documentos y contacto -->
            <h6 class="col-12 mt-3 text-muted">Documentos e identificación</h6>

            <div class="col-md-6">
              <label class="form-label">Cédula de identidad <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="ci" value="<%= formData?.ci || '' %>" required pattern="^[0-9]{7,8}[A-Z]?$" title="Formato: 7-8 dígitos + letra opcional" placeholder="Ej: 12345678 o 12345678A" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Correo electrónico</label>
              <input type="email" class="form-control" name="correo" value="<%= formData?.correo || '' %>" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Teléfono/Celular <span class="text-danger">*</span></label>
              <input type="tel" class="form-control" name="celular" value="<%= formData?.celular || '' %>" required pattern="^[0-9]{10,11}$" title="10-11 dígitos sin espacios" placeholder="Ej: 71234567" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Nacionalidad</label>
              <input type="text" class="form-control" name="nacionalidad" value="<%= formData?.nacionalidad || '' %>" />
            </div>

            <!-- Datos médicos y civiles -->
            <h6 class="col-12 mt-3 text-muted">Datos médicos y civiles</h6>

            <div class="col-md-4">
              <label class="form-label">Tipo de sangre</label>
              <select class="form-select" name="tipo_sangre">
                <option value="">-- Seleccionar --</option>
                <option value="O+" <%= formData?.tipo_sangre === 'O+' ? 'selected' : '' %>>O+</option>
                <option value="O-" <%= formData?.tipo_sangre === 'O-' ? 'selected' : '' %>>O-</option>
                <option value="A+" <%= formData?.tipo_sangre === 'A+' ? 'selected' : '' %>>A+</option>
                <option value="A-" <%= formData?.tipo_sangre === 'A-' ? 'selected' : '' %>>A-</option>
                <option value="B+" <%= formData?.tipo_sangre === 'B+' ? 'selected' : '' %>>B+</option>
                <option value="B-" <%= formData?.tipo_sangre === 'B-' ? 'selected' : '' %>>B-</option>
                <option value="AB+" <%= formData?.tipo_sangre === 'AB+' ? 'selected' : '' %>>AB+</option>
                <option value="AB-" <%= formData?.tipo_sangre === 'AB-' ? 'selected' : '' %>>AB-</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Estado civil</label>
              <select class="form-select" name="estado_civil">
                <option value="">-- Seleccionar --</option>
                <option value="Soltero/a" <%= formData?.estado_civil === 'Soltero/a' ? 'selected' : '' %>>Soltero/a</option>
                <option value="Casado/a" <%= formData?.estado_civil === 'Casado/a' ? 'selected' : '' %>>Casado/a</option>
                <option value="Divorciado/a" <%= formData?.estado_civil === 'Divorciado/a' ? 'selected' : '' %>>Divorciado/a</option>
                <option value="Viudo/a" <%= formData?.estado_civil === 'Viudo/a' ? 'selected' : '' %>>Viudo/a</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Contacto de emergencia</label>
              <input type="text" class="form-control" id="contacto_emerg" name="contacto_emerg" value="<%= formData?.contacto_emerg || '' %>" placeholder="Ej: Maria - 78856765" title="Formato: Nombre - Número (máximo 20 dígitos)" />
              <small class="form-text text-muted d-block mt-1">Formato: Nombre - Número (ej: Maria - 78856765)</small>
            </div>

            <!-- Domicilio -->
            <h6 class="col-12 mt-3 text-muted">Domicilio</h6>

            <div class="col-12">
              <label class="form-label">Domicilio</label>
              <input type="text" class="form-control" name="domicilio" value="<%= formData?.domicilio || '' %>" />
            </div>

            <!-- Antecedentes médicos -->
            <h6 class="col-12 mt-3 text-muted">Antecedentes médicos</h6>

            <div class="col-12">
              <label class="form-label">Alergias</label>
              <textarea class="form-control" name="alergias" rows="2"><%= formData?.alergias || '' %></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Enfermedades base</label>
              <textarea class="form-control" name="enfermedad_base" rows="2"><%= formData?.enfermedad_base || '' %></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Observaciones</label>
              <textarea class="form-control" name="observaciones" rows="2"><%= formData?.observaciones || '' %></textarea>
            </div>

            <!-- Aseguradora (opcional) -->
            <h6 class="col-12 mt-3 text-muted">Información de Aseguradora (Opcional)</h6>

            <div class="col-md-6">
              <label class="form-label">Aseguradora</label>
              <select class="form-select" name="id_aseguradora">
                <option value="">-- Sin aseguradora --</option>
                <% aseguradoras.forEach(a => { %>
                  <option value="<%= a.id_aseguradora %>" <%= formData?.id_aseguradora === a.id_aseguradora ? 'selected' : '' %>>
                    <%= a.nombre %> (<%= a.porcentaje_cobertura %>% cobertura)
                  </option>
                <% }); %>
              </select>
              <small class="form-text text-muted">Selecciona una aseguradora si el paciente cuenta con una</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Número de Póliza</label>
              <input type="text" class="form-control" name="numero_poliza" value="<%= formData?.numero_poliza || '' %>" placeholder="Número de póliza (opcional)" />
              <small class="form-text text-muted">Número de la póliza de la aseguradora</small>
            </div>

            <!-- Botones -->
            <div class="col-12 mt-4">
              <button type="submit" class="btn btn-primary me-2"><i class="bi bi-check-lg me-1"></i>Registrar</button>
              <a href="/pacientes" class="btn btn-outline-secondary"><i class="bi bi-x-lg me-1"></i>Cancelar</a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Validación del campo "Contacto de emergencia"
  document.getElementById('contacto_emerg').addEventListener('blur', function() {
    const valor = this.value.trim();
    
    if (valor === '') {
      // Campo vacío es permitido (no obligatorio)
      this.classList.remove('is-invalid');
      return;
    }
    
    // Validar formato: "Nombre - Número"
    const regex = /^([a-zA-ZáéíóúñÁÉÍÓÚÑ\s]+)\s*-\s*(\d{8,14})$/;
    
    if (!regex.test(valor)) {
      this.classList.add('is-invalid');
      
      // Agregar mensaje de error si no existe
      let errorMsg = this.nextElementSibling?.classList.contains('invalid-feedback');
      if (!errorMsg) {
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'invalid-feedback d-block';
        feedbackDiv.textContent = 'Formato inválido. Use: Nombre - Número (ej: Maria - 78856765)';
        this.parentNode.insertBefore(feedbackDiv, this.nextElementSibling);
      }
    } else {
      this.classList.remove('is-invalid');
      // Remover mensaje de error si existe
      if (this.nextElementSibling?.classList.contains('invalid-feedback')) {
        this.nextElementSibling.remove();
      }
    }
  });
  
  // Validación al enviar el formulario
  document.querySelector('form.needs-validation').addEventListener('submit', function(e) {
    const contactoEmerg = document.getElementById('contacto_emerg');
    const valor = contactoEmerg.value.trim();
    
    if (valor !== '') {
      const regex = /^([a-zA-ZáéíóúñÁÉÍÓÚÑ\s]+)\s*-\s*(\d{8,14})$/;
      
      if (!regex.test(valor)) {
        e.preventDefault();
        e.stopPropagation();
        contactoEmerg.classList.add('is-invalid');
        contactoEmerg.focus();
        
        if (!contactoEmerg.nextElementSibling?.classList.contains('invalid-feedback')) {
          const feedbackDiv = document.createElement('div');
          feedbackDiv.className = 'invalid-feedback d-block';
          feedbackDiv.textContent = 'Formato inválido. Use: Nombre - Número (ej: Maria - 78856765)';
          contactoEmerg.parentNode.insertBefore(feedbackDiv, contactoEmerg.nextElementSibling);
        }
        return false;
      }
    }
  });
</script>
