<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Buscar Paciente - Sejsi Multiconsultorio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      body { background: #f5f7fb; }
      .search-hero { 
        background: linear-gradient(135deg, #1abc9c 0%, #0f9a6f 100%); 
        color: #fff; 
        padding: 2rem 0;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(26, 188, 156, 0.2);
      }
      .search-input {
        border-radius: 25px;
        padding: 12px 20px;
        border: none;
        font-size: 1rem;
      }
      .search-input:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.2);
      }
      .result-card {
        border: none;
        border-left: 4px solid #1abc9c;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
      }
      .result-card:hover {
        transform: translateX(5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      }
      .patient-code {
        background: #f0f9f8;
        color: #0f9a6f;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
      }
      .search-filters {
        margin: 1.5rem 0;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <!-- Header con búsqueda -->
      <div class="search-hero">
        <div class="container">
          <h2 class="mb-3"><i class="bi bi-search me-2"></i>Buscar Paciente</h2>
          <p class="lead mb-0">Búsqueda por CI, Nombre o Código de Paciente</p>
        </div>
      </div>

      <!-- Formulario de búsqueda -->
      <div class="row mb-4">
        <div class="col-12 col-lg-8 mx-auto">
          <form method="get" action="/pacientes/buscar" class="d-flex gap-2">
            <input 
              type="text" 
              name="q" 
              class="search-input flex-grow-1" 
              placeholder="Buscar por Cédula, Nombre o Código de Paciente..." 
              value="<%= termino %>"
              required
            />
            <button type="submit" class="btn btn-primary btn-lg rounded-pill">
              <i class="bi bi-search"></i> Buscar
            </button>
            <a href="/pacientes" class="btn btn-outline-secondary btn-lg rounded-pill" title="Volver al listado">
              <i class="bi bi-arrow-left"></i>
            </a>
          </form>
        </div>
      </div>

      <!-- Resultados -->
      <div class="row">
        <div class="col-12 col-lg-8 mx-auto">
          <% if (termino && termino.trim().length > 0) { %>
            <% if (pacientes && pacientes.length > 0) { %>
              <div class="mb-3">
                <h5 class="text-muted">
                  <i class="bi bi-check-circle text-success me-2"></i>
                  Se encontraron <strong><%= pacientes.length %></strong> resultado<%= pacientes.length !== 1 ? 's' : '' %>
                </h5>
              </div>
              
              <% if (pacientes.length >= 50) { %>
                <div class="alert alert-info mb-3" role="alert">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>Resultados limitados:</strong> Se muestran máximo 50 resultados. Refine su búsqueda para obtener resultados más específicos.
                </div>
              <% } %>

              <div class="row">
                <% pacientes.forEach(p => { %>
                  <div class="col-12">
                    <div class="result-card card">
                      <div class="card-body">
                        <div class="row align-items-center">
                          <!-- Información del paciente -->
                          <div class="col-12 col-md-8">
                            <div class="mb-2">
                              <span class="patient-code"><%= p.codigo_paciente %></span>
                              <% if (!p.estado) { %>
                                <span class="badge bg-danger ms-2">Inactivo</span>
                              <% } %>
                            </div>
                            <h5 class="mb-2">
                              <strong><%= p.nombre %> <%= p.apellido_paterno %></strong>
                              <% if (p.apellido_materno) { %>
                                <span class="text-muted"><%= p.apellido_materno %></span>
                              <% } %>
                            </h5>
                            <div class="text-muted small">
                              <% if (p.ci) { %>
                                <div><i class="bi bi-card-text me-2"></i><strong>Cédula:</strong> <%= p.ci %></div>
                              <% } %>
                              <% if (p.celular) { %>
                                <div><i class="bi bi-telephone me-2"></i><strong>Teléfono:</strong> <%= p.celular %></div>
                              <% } %>
                              <% if (p.correo) { %>
                                <div><i class="bi bi-envelope me-2"></i><strong>Correo:</strong> <%= p.correo %></div>
                              <% } %>
                            </div>
                          </div>

                          <!-- Acciones -->
                          <div class="col-12 col-md-4 mt-3 mt-md-0">
                            <div class="d-grid gap-2">
                              <button type="button" class="btn btn-info btn-sm" onclick="abrirModalDetallesBuscar('<%= p.id_paciente %>')">
                                <i class="bi bi-eye me-1"></i>Ver Detalles
                              </button>
                              <button type="button" class="btn btn-primary btn-sm" onclick="abrirModalEditarBuscar('<%= p.id_paciente %>')">
                                <i class="bi bi-pencil me-1"></i>Editar
                              </button>
                              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copiarCodigo('<%= p.codigo_paciente %>')">
                                <i class="bi bi-clipboard me-1"></i>Copiar Código
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            <% } else { %>
              <div class="alert alert-warning text-center py-5">
                <i class="bi bi-search fs-3 mb-3 d-block"></i>
                <h5 class="mb-2">No se encontraron resultados</h5>
                <p class="text-muted mb-0">Intenta buscar con otro término o verifica que el paciente esté registrado en el sistema.</p>
              </div>
            <% } %>
          <% } else { %>
            <div class="alert alert-info text-center py-5">
              <i class="bi bi-info-circle fs-3 mb-3 d-block"></i>
              <h5 class="mb-2">Ingresa un término de búsqueda</h5>
              <p class="text-muted mb-0">Puedes buscar por Cédula, Nombre o Código de Paciente</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <script>
      function copiarCodigo(codigo) {
        navigator.clipboard.writeText(codigo).then(() => {
          showNotification('Código copiado', 'El código del paciente fue copiado al portapapeles.');
        });
      }

      function showNotification(title, message) {
        const toastHtml = `
          <div class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body">
                <strong>${title}:</strong> ${message}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        `;
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = toastHtml;
        const toastEl = tempDiv.firstElementChild;
        
        toastEl.style.position = 'fixed';
        toastEl.style.top = '20px';
        toastEl.style.right = '20px';
        toastEl.style.minWidth = '300px';
        toastEl.style.zIndex = '9999';
        
        document.body.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
        
        toastEl.addEventListener('hidden.bs.toast', () => {
          toastEl.remove();
        });
      }

      async function abrirModalDetallesBuscar(idPaciente) {
        const modalHtml = `
          <div class="modal fade" id="modalDetallesBuscar" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-lg">
              <div class="modal-content border-0 shadow-lg">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 1050;"></button>
                <div id="modalDetallesBody">
                  <div class="text-center py-5">
                    <div class="spinner-border text-success" role="status">
                      <span class="visually-hidden">Cargando detalles...</span>
                    </div>
                    <p class="text-muted mt-3">Cargando información del paciente...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Crear y agregar el modal
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = modalHtml;
        const modalEl = tempDiv.firstElementChild;
        document.body.appendChild(modalEl);
        
        const modal = new bootstrap.Modal(modalEl);
        const modalBody = document.getElementById('modalDetallesBody');
        
        try {
          const response = await fetch(`/pacientes/obtener-detalles/${idPaciente}`);
          if (!response.ok) throw new Error('Error al cargar');
          const html = await response.text();
          modalBody.innerHTML = html;
          modal.show();
          
          // Limpiar modal al cerrarlo
          modalEl.addEventListener('hidden.bs.modal', () => {
            modalEl.remove();
          });
        } catch (err) {
          modalBody.innerHTML = '<div class="alert alert-danger m-4"><i class="bi bi-exclamation-triangle me-2"></i>Error al cargar los detalles.</div>';
        }
      }

      async function abrirModalEditarBuscar(idPaciente) {
        const modalHtml = `
          <div class="modal fade" id="modalEditarBuscar" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-lg">
              <div class="modal-content">
                <div class="modal-header border-bottom">
                  <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar paciente</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="modalEditarBody" class="modal-body">
                  <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Cargando formulario...</span>
                    </div>
                    <p class="text-muted mt-3">Cargando formulario...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Crear y agregar el modal
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = modalHtml;
        const modalEl = tempDiv.firstElementChild;
        document.body.appendChild(modalEl);
        
        const modal = new bootstrap.Modal(modalEl);
        const modalBody = document.getElementById('modalEditarBody');
        
        try {
          const response = await fetch(`/pacientes/obtener-form/${idPaciente}`);
          if (!response.ok) throw new Error('Error al cargar');
          const html = await response.text();
          modalBody.innerHTML = html;
          modal.show();
          
          // Asignar evento al formulario
          setTimeout(() => {
            const form = modalBody.querySelector('form');
            if (form) {
              form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const url = form.getAttribute('action');
                const formData = new FormData(form);
                try {
                  const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                  });
                  if (response.ok) {
                    modal.hide();
                    showNotification('Éxito', 'Paciente actualizado exitosamente.');
                    setTimeout(() => window.location.reload(), 1000);
                  } else {
                    const data = await response.json();
                    showNotification('Error', data.mensaje || 'No se pudo actualizar el paciente.', 'danger');
                  }
                } catch (err) {
                  showNotification('Error', 'Error al enviar el formulario.', 'danger');
                }
              });
            }
          }, 100);
          
          // Limpiar modal al cerrarlo
          modalEl.addEventListener('hidden.bs.modal', () => {
            modalEl.remove();
          });
        } catch (err) {
          modalBody.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error al cargar el formulario.</div>';
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
