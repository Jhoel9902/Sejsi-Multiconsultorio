<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body p-4">
        <!-- Header -->
        <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
          <h5 class="card-title mb-0"><i class="bi bi-link-45deg me-2"></i>Asignar Aseguradoras a Pacientes</h5>
          <a href="/aseguradoras" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left me-1"></i>Volver</a>
        </div>

        <!-- Alertas de error -->
        <% if (error && error.trim() !== '') { %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i><strong>Error:</strong> <%= error %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        <% } %>

        <!-- Formulario de asignación -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title mb-3"><i class="bi bi-plus-circle me-2"></i>Asignar Nueva Aseguradora</h6>

                <div class="mb-3">
                  <label for="inputBuscarPaciente" class="form-label">Paciente <span class="text-danger">*</span></label>
                  <div class="position-relative">
                    <input 
                      type="text" 
                      id="inputBuscarPaciente" 
                      class="form-control" 
                      placeholder="Buscar por nombre, CI o apellido..."
                      autocomplete="off">
                    <div 
                      id="listaPacientesDropdown" 
                      class="position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm"
                      style="display: none; max-height: 250px; overflow-y: auto; z-index: 1000; top: 100%;">
                    </div>
                  </div>
                  <input 
                    type="hidden" 
                    id="selectPaciente" 
                    value="">
                  <small class="d-block text-muted mt-1" id="pacienteSeleccionado"></small>
                </div>

                <div class="mb-3">
                  <label for="selectAseguradora" class="form-label">Aseguradora <span class="text-danger">*</span></label>
                  <select id="selectAseguradora" class="form-select" required>
                    <option value="">-- Seleccionar aseguradora --</option>
                    <% aseguradoras.forEach(ase => { %>
                      <option value="<%= ase.id_aseguradora %>"><%= ase.nombre %> (<%= ase.porcentaje_cobertura %>%)</option>
                    <% }); %>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="inputPoliza" class="form-label">Número de Póliza <span class="text-danger">*</span></label>
                  <input type="text" id="inputPoliza" class="form-control" placeholder="Ej: POL-2025-00001" required>
                </div>

                <button type="button" id="btnAsignar" class="btn btn-primary w-100" onclick="asignarAseguradora()">
                  <i class="bi bi-link-45deg me-1"></i>Asignar
                </button>
              </div>
            </div>
          </div>

          <!-- Resumen de asignaciones -->
          <div class="col-md-6">
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title mb-3"><i class="bi bi-list-check me-2"></i>Aseguradoras por Paciente</h6>

                <% if (pacientes && pacientes.length > 0) { %>
                  <div class="list-group list-group-sm">
                    <% pacientes.forEach(pac => { %>
                      <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                          <div>
                            <h6 class="mb-1 text-truncate"><%= pac.nombres %></h6>
                            <small class="text-muted">C.I.: <%= pac.ci %></small>
                          </div>
                        </div>
                        <div class="mt-2">
                          <% if (pac.aseguradoras && pac.aseguradoras.trim() !== '') { %>
                            <div class="d-flex flex-wrap gap-2">
                              <% pac.aseguradoras.split(', ').forEach(aseg => { %>
                                <span class="badge bg-success"><%= aseg %></span>
                              <% }); %>
                            </div>
                          <% } else { %>
                            <span class="badge bg-secondary">Sin aseguradoras</span>
                          <% } %>
                        </div>
                      </div>
                    <% }); %>
                  </div>

                  <!-- Paginación -->
                  <% if (pagination.totalPages > 1) { %>
                    <nav class="mt-3" aria-label="Paginación de pacientes">
                      <ul class="pagination pagination-sm justify-content-center mb-0">
                        <% if (pagination.hasPrevPage) { %>
                          <li class="page-item">
                            <a class="page-link" href="/aseguradoras/asignar?page=1"><i class="bi bi-chevron-double-left"></i></a>
                          </li>
                          <li class="page-item">
                            <a class="page-link" href="/aseguradoras/asignar?page=<%= pagination.page - 1 %>"><i class="bi bi-chevron-left"></i></a>
                          </li>
                        <% } %>

                        <% 
                          let startPage = Math.max(1, pagination.page - 1);
                          let endPage = Math.min(pagination.totalPages, pagination.page + 1);
                        %>

                        <% if (startPage > 1) { %>
                          <li class="page-item">
                            <a class="page-link" href="/aseguradoras/asignar?page=1">1</a>
                          </li>
                          <% if (startPage > 2) { %>
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                          <% } %>
                        <% } %>

                        <% for (let i = startPage; i <= endPage; i++) { %>
                          <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                            <a class="page-link" href="/aseguradoras/asignar?page=<%= i %>"><%= i %></a>
                          </li>
                        <% } %>

                        <% if (endPage < pagination.totalPages) { %>
                          <% if (endPage < pagination.totalPages - 1) { %>
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                          <% } %>
                          <li class="page-item">
                            <a class="page-link" href="/aseguradoras/asignar?page=<%= pagination.totalPages %>"><%= pagination.totalPages %></a>
                          </li>
                        <% } %>

                        <% if (pagination.hasNextPage) { %>
                          <li class="page-item">
                            <a class="page-link" href="/aseguradoras/asignar?page=<%= pagination.page + 1 %>"><i class="bi bi-chevron-right"></i></a>
                          </li>
                          <li class="page-item">
                            <a class="page-link" href="/aseguradoras/asignar?page=<%= pagination.totalPages %>"><i class="bi bi-chevron-double-right"></i></a>
                          </li>
                        <% } %>
                      </ul>
                    </nav>
                    <div class="text-center mt-2">
                      <small class="text-muted">Mostrando <%= pacientes.length %> de <%= pagination.totalPacientes %> pacientes (página <%= pagination.page %> de <%= pagination.totalPages %>)</small>
                    </div>
                  <% } %>
                <% } else { %>
                  <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle me-2"></i>No hay pacientes registrados.
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla detallada de asignaciones -->
        <div class="card">
          <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-table me-2"></i>Detalle de Asignaciones</h6>
          </div>
          <div class="card-body p-0">
            <% if (pacientes && pacientes.length > 0) { %>
              <div class="table-responsive">
                <table class="table table-hover table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="fw-semibold">Paciente</th>
                      <th class="fw-semibold">C.I.</th>
                      <th class="fw-semibold d-none d-md-table-cell">Celular</th>
                      <th class="fw-semibold">Aseguradoras Activas</th>
                      <th class="fw-semibold text-center">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% pacientes.forEach(pac => { %>
                      <tr>
                        <td><strong><%= pac.nombres %></strong></td>
                        <td><%= pac.ci %></td>
                        <td class="d-none d-md-table-cell"><small><%= pac.celular || '-' %></small></td>
                        <td>
                          <% if (pac.aseguradoras && pac.aseguradoras.trim() !== '') { %>
                            <% pac.aseguradoras.split(', ').forEach((aseg, index) => { %>
                              <span class="badge bg-success me-1" style="cursor: pointer;" onclick="removerAseguradora('<%= pac.id_paciente %>', '<%= aseg %>')">
                                <%= aseg %> <i class="bi bi-x-circle" style="font-size: 0.8em;"></i>
                              </span>
                            <% }); %>
                          <% } else { %>
                            <span class="badge bg-secondary">Sin aseguradoras</span>
                          <% } %>
                        </td>
                        <td class="text-center">
                          <button type="button" class="btn btn-sm btn-outline-success" onclick="seleccionarPaciente('<%= pac.id_paciente %>', '<%= pac.nombres %>', '<%= pac.ci %>')" title="Agregar aseguradora">
                            <i class="bi bi-plus-circle"></i>
                          </button>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="p-4 text-center text-muted">
                <i class="bi bi-info-circle me-2"></i>No hay pacientes registrados.
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Variables globales
let pacientesCache = [];
let debounceTimer = null;

// Función de búsqueda dinámica de pacientes
async function buscarPacientes(query) {
  const inputBuscar = document.getElementById('inputBuscarPaciente');
  const dropdown = document.getElementById('listaPacientesDropdown');

  if (!query || query.trim().length < 1) {
    dropdown.style.display = 'none';
    return;
  }

  try {
    const response = await fetch(`/aseguradoras/buscar-pacientes?q=${encodeURIComponent(query)}`);
    const data = await response.json();

    if (data.success && data.pacientes.length > 0) {
      dropdown.innerHTML = '';
      
      data.pacientes.forEach(pac => {
        const item = document.createElement('div');
        item.className = 'p-2 border-bottom cursor-pointer hover-bg-light';
        item.style.cursor = 'pointer';
        item.innerHTML = `
          <div class="fw-bold">${pac.nombre}</div>
          <small class="text-muted">C.I.: ${pac.ci} | Celular: ${pac.celular}</small>
        `;
        
        item.addEventListener('click', () => {
          seleccionarPaciente(pac.id_paciente, pac.nombre, pac.ci);
          dropdown.style.display = 'none';
          inputBuscar.value = '';
        });
        
        item.addEventListener('mouseenter', function() {
          this.style.backgroundColor = '#f5f5f5';
        });
        
        item.addEventListener('mouseleave', function() {
          this.style.backgroundColor = 'transparent';
        });
        
        dropdown.appendChild(item);
      });
      
      dropdown.style.display = 'block';
    } else {
      dropdown.innerHTML = '<div class="p-3 text-muted text-center">No se encontraron pacientes</div>';
      dropdown.style.display = 'block';
    }
  } catch (error) {
    console.error('Error al buscar pacientes:', error);
    dropdown.innerHTML = '<div class="p-3 text-danger text-center">Error en la búsqueda</div>';
    dropdown.style.display = 'block';
  }
}

// Event listener para búsqueda con debounce
document.getElementById('inputBuscarPaciente').addEventListener('input', (e) => {
  clearTimeout(debounceTimer);
  const query = e.target.value.trim();

  if (query.length === 0) {
    document.getElementById('listaPacientesDropdown').style.display = 'none';
    return;
  }

  debounceTimer = setTimeout(() => {
    buscarPacientes(query);
  }, 300);
});

// Cerrar dropdown al hacer clic fuera
document.addEventListener('click', (e) => {
  const dropdown = document.getElementById('listaPacientesDropdown');
  const inputBuscar = document.getElementById('inputBuscarPaciente');
  
  if (!dropdown.contains(e.target) && e.target !== inputBuscar) {
    dropdown.style.display = 'none';
  }
});

// Seleccionar paciente desde búsqueda o tabla
function seleccionarPaciente(idPaciente, nombrePaciente, ci = null) {
  document.getElementById('selectPaciente').value = idPaciente;
  
  // Limpiar la búsqueda
  document.getElementById('inputBuscarPaciente').value = '';
  document.getElementById('listaPacientesDropdown').style.display = 'none';
  
  // Mostrar paciente seleccionado
  if (ci) {
    document.getElementById('pacienteSeleccionado').textContent = `Paciente seleccionado: ${nombrePaciente} (C.I.: ${ci})`;
  } else {
    document.getElementById('pacienteSeleccionado').textContent = `Paciente seleccionado: ${nombrePaciente}`;
  }
  
  // Enfoque en aseguradora
  setTimeout(() => {
    document.getElementById('selectAseguradora').focus();
  }, 100);
  
  // Desplazar al formulario
  document.querySelector('.card-body').scrollIntoView({ behavior: 'smooth' });
}

// Asignar aseguradora a paciente
function asignarAseguradora() {
  const idPaciente = document.getElementById('selectPaciente').value;
  const idAseguradora = document.getElementById('selectAseguradora').value;
  const numeroPoliza = document.getElementById('inputPoliza').value.trim();

  if (!idPaciente) {
    alert('Por favor selecciona un paciente');
    return;
  }
  if (!idAseguradora) {
    alert('Por favor selecciona una aseguradora');
    return;
  }
  if (!numeroPoliza) {
    alert('Por favor ingresa el número de póliza');
    return;
  }

  const btnAsignar = document.getElementById('btnAsignar');
  const btnText = btnAsignar.innerHTML;
  btnAsignar.disabled = true;
  btnAsignar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Asignando...';

  fetch('/aseguradoras/asignar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      id_paciente: idPaciente,
      id_aseguradora: idAseguradora,
      numero_poliza: numeroPoliza
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.mensaje);
      // Limpiar formulario
      document.getElementById('inputBuscarPaciente').value = '';
      document.getElementById('selectPaciente').value = '';
      document.getElementById('pacienteSeleccionado').textContent = '';
      document.getElementById('selectAseguradora').value = '';
      document.getElementById('inputPoliza').value = '';
      // Recargar página
      setTimeout(() => location.reload(), 500);
    } else {
      alert('Error: ' + data.mensaje);
    }
  })
  .catch(err => {
    alert('Error: ' + err.message);
  })
  .finally(() => {
    btnAsignar.disabled = false;
    btnAsignar.innerHTML = btnText;
  });
}

// Remover aseguradora de paciente
function removerAseguradora(idPaciente, nombreAseguradora) {
  if (!confirm('¿Estás seguro de que deseas remover la aseguradora "' + nombreAseguradora + '" de este paciente?')) {
    return;
  }

  // Buscar el id_aseguradora basado en el nombre
  const selectAseguradora = document.getElementById('selectAseguradora');
  let idAseguradora = null;
  
  for (let option of selectAseguradora.options) {
    if (option.text.includes(nombreAseguradora)) {
      idAseguradora = option.value;
      break;
    }
  }

  if (!idAseguradora) {
    alert('No se pudo encontrar la aseguradora. Recarga la página e intenta de nuevo.');
    return;
  }

  fetch('/aseguradoras/desasignar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      id_paciente: idPaciente,
      id_aseguradora: idAseguradora
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(data.mensaje);
      setTimeout(() => location.reload(), 500);
    } else {
      alert('Error: ' + data.mensaje);
    }
  })
  .catch(err => {
    alert('Error: ' + err.message);
  });
}
</script>
