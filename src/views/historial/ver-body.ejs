<!-- DETALLES DEL HISTORIAL MÉDICO -->
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-12">
            <!-- Encabezado -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-file-medical me-2"></i>Detalles del Historial</h4>
                    <a href="/historial/consultar" class="btn btn-light btn-sm">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Paciente:</strong> <%= historial.nombre_paciente %></p>
                            <p class="mb-2"><strong>C.I.:</strong> <%= historial.ci %></p>
                            <p class="mb-2"><strong>Tipo de Sangre:</strong> <%= historial.tipo_sangre || 'N/A' %></p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Médico:</strong> <%= historial.nombre_medico %></p>
                            <p class="mb-2"><strong>Fecha Cita:</strong> <%= new Date(historial.fecha_cita).toLocaleDateString('es-ES') %><% if (historial.hora_cita) { %> a las <%= typeof historial.hora_cita === 'string' ? historial.hora_cita.substring(0, 5) : new Date(historial.hora_cita).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) %><% } %></p>
                            <p class="mb-2"><strong>Fecha Registro:</strong> <%= new Date(historial.fecha_creacion).toLocaleDateString('es-ES') %></p>
                        </div>
                    </div>
                    <% if (historial.alergias) { %>
                        <div class="alert alert-warning mt-3 mb-0">
                            <strong><i class="bi bi-exclamation-triangle me-2"></i>Alergias:</strong> <%= historial.alergias %>
                        </div>
                    <% } %>
                </div>
            </div>

            <div class="row">
                <!-- Información Médica -->
                <div class="col-lg-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Información Médica</h5>
                        </div>
                        <div class="card-body">
                            <form id="formEditar">
                                <div class="mb-3">
                                    <label class="form-label"><strong>Diagnósticos</strong></label>
                                    <textarea class="form-control" id="diagnosticos" rows="3" readonly><%= historial.diagnosticos || '' %></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><strong>Evoluciones</strong></label>
                                    <textarea class="form-control" id="evoluciones" rows="3" readonly><%= historial.evoluciones || '' %></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><strong>Antecedentes</strong></label>
                                    <textarea class="form-control" id="antecedentes" rows="3" readonly><%= historial.antecedentes || '' %></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><strong>Tratamientos</strong></label>
                                    <textarea class="form-control" id="tratamientos" rows="3" readonly><%= historial.tratamientos || '' %></textarea>
                                </div>

                                <button type="button" class="btn btn-warning" id="btnEditar">
                                    <i class="bi bi-pencil me-2"></i>Editar
                                </button>
                                <button type="submit" class="btn btn-success" id="btnGuardar" style="display: none;">
                                    <i class="bi bi-check-circle me-2"></i>Guardar Cambios
                                </button>
                                <button type="button" class="btn btn-secondary" id="btnCancelar" style="display: none;">
                                    <i class="bi bi-x-circle me-2"></i>Cancelar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Estudios -->
                <div class="col-lg-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-images me-2"></i>Estudios e Imágenes</h5>
                        </div>
                        <div class="card-body">
                            <!-- Formulario de carga -->
                            <div class="mb-4">
                                <h6 class="mb-3">Agregar Nuevo Estudio</h6>
                                <form id="formSubirEstudio">
                                    <div class="mb-2">
                                        <label for="nombreEstudio" class="form-label">Nombre del Estudio</label>
                                        <input type="text" class="form-control" id="nombreEstudio" placeholder="Ej: Radiografía Tórax" required>
                                    </div>
                                    <div class="mb-2">
                                        <label for="archivoEstudio" class="form-label">Archivo (Imagen/PDF)</label>
                                        <input type="file" class="form-control" id="archivoEstudio" accept="image/*,.pdf" required>
                                    </div>
                                    <button type="submit" class="btn btn-success btn-sm w-100">
                                        <i class="bi bi-cloud-upload me-2"></i>Subir Estudio
                                    </button>
                                </form>
                            </div>

                            <hr>

                            <!-- Lista de estudios -->
                            <h6 class="mb-3">Estudios Cargados</h6>
                            <div id="listaEstudios">
                                <% if (estudios && estudios.length > 0) { %>
                                    <% estudios.forEach(estudio => { %>
                                        <div class="card mb-2" data-id="<%= estudio.id_estudio %>">
                                            <div class="card-body p-2">
                                                <p class="card-title mb-1" style="font-size: 0.9rem;">
                                                    <strong><%= estudio.nombre_estudio %></strong>
                                                </p>
                                                <small class="text-muted d-block mb-2">
                                                    <%= new Date(estudio.fecha_subida).toLocaleDateString('es-ES') %>
                                                </small>
                                                <button type="button" class="btn btn-info btn-sm w-100" onclick="verEstudio('<%= estudio.foto %>', '<%= estudio.nombre_estudio %>')">
                                                    <i class="bi bi-eye"></i> Ver
                                                </button>
                                            </div>
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <div class="alert alert-secondary mb-0">
                                        <small>No hay estudios cargados aún.</small>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recetas Emitidas -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Recetas Emitidas</h5>
                </div>
                <div class="card-body">
                    <!-- Formulario para nueva receta -->
                    <div class="mb-4">
                        <h6 class="mb-3">Agregar Nueva Receta</h6>
                        <form id="formAgregarReceta">
                            <div class="row">
                                <div class="col-md-12 mb-2">
                                    <label for="medicamento_nombre" class="form-label">Medicamento *</label>
                                    <input type="text" class="form-control" id="medicamento_nombre" placeholder="Ej: Paracetamol" required>
                                </div>
                                <div class="col-md-12 mb-2">
                                    <label for="presentacion" class="form-label">Presentación</label>
                                    <input type="text" class="form-control" id="presentacion" placeholder="Ej: Tabletas, Cápsulas, Jarabe">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="dosis" class="form-label">Dosis (Ej: 500 mg)</label>
                                    <input type="text" class="form-control" id="dosis" placeholder="Ej: 500 mg, 2.5 ml">
                                    <small class="text-muted">Formato: número + unidad (mg, ml, g, %)</small>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="frecuencia" class="form-label">Frecuencia</label>
                                    <input type="text" class="form-control" id="frecuencia" placeholder="Ej: Cada 8 horas">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="duracion" class="form-label">Duración</label>
                                    <input type="text" class="form-control" id="duracion" placeholder="Ej: 7 días">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="indicaciones" class="form-label">Indicaciones</label>
                                    <input type="text" class="form-control" id="indicaciones" placeholder="Ej: Tomar con alimentos">
                                </div>
                                <div class="col-md-12">
                                    <button type="submit" class="btn btn-danger btn-sm">
                                        <i class="bi bi-plus-circle me-2"></i>Agregar Receta
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <hr>

                    <!-- Lista de recetas -->
                    <h6 class="mb-3">Recetas del Paciente</h6>
                    <div id="listaRecetas">
                        <div class="alert alert-secondary">
                            <small>Cargando recetas...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const idHistorial = '<%= historial.id_historial %>';

// Editar modo
document.getElementById('btnEditar').addEventListener('click', () => {
    document.querySelectorAll('#formEditar textarea').forEach(el => el.removeAttribute('readonly'));
    document.getElementById('btnEditar').style.display = 'none';
    document.getElementById('btnGuardar').style.display = 'inline-block';
    document.getElementById('btnCancelar').style.display = 'inline-block';
});

document.getElementById('btnCancelar').addEventListener('click', () => {
    location.reload();
});

document.getElementById('formEditar').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = document.getElementById('btnGuardar');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
    
    try {
        const response = await fetch(`/historial/${idHistorial}/actualizar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                diagnosticos: document.getElementById('diagnosticos').value,
                evoluciones: document.getElementById('evoluciones').value,
                antecedentes: document.getElementById('antecedentes').value,
                tratamientos: document.getElementById('tratamientos').value
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Historial actualizado exitosamente');
            location.reload();
        } else {
            alert('Error: ' + data.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Guardar Cambios';
    }
});

// Subir estudio
document.getElementById('formSubirEstudio').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const nombre = document.getElementById('nombreEstudio').value;
    const archivo = document.getElementById('archivoEstudio').files[0];
    
    if (!archivo) {
        alert('Selecciona un archivo');
        return;
    }
    
    const formData = new FormData();
    formData.append('nombre_estudio', nombre);
    formData.append('archivo_estudio', archivo);
    
    const btn = e.target.querySelector('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Subiendo...';
    
    try {
        const response = await fetch(`/historial/${idHistorial}/estudios`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Estudio cargado exitosamente');
            location.reload();
        } else {
            alert('Error: ' + data.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al subir estudio');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>Subir Estudio';
    }
});

// Ver estudio en modal
function verEstudio(rutaArchivo, nombreEstudio) {
    // Verificar si es una imagen o PDF
    const esImagen = /\.(jpg|jpeg|png|gif|webp)$/i.test(rutaArchivo);
    const esPDF = /\.pdf$/i.test(rutaArchivo);
    
    let contenido = '';
    
    if (esImagen) {
        contenido = `<img src="${rutaArchivo}" alt="${nombreEstudio}" style="max-width: 100%; height: auto;">`;
    } else if (esPDF) {
        contenido = `
            <div style="width: 100%; height: 500px; border: 1px solid #ddd;">
                <iframe src="${rutaArchivo}" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        `;
    } else {
        contenido = `<p class="text-muted">Archivo no soportado para previsualización. <a href="${rutaArchivo}" target="_blank" download>Descargar</a></p>`;
    }
    
    // Crear modal dinámico
    const modalHTML = `
        <div class="modal fade" id="modalEstudio" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${nombreEstudio}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${contenido}
                    </div>
                    <div class="modal-footer">
                        <a href="${rutaArchivo}" class="btn btn-primary" download>
                            <i class="bi bi-download"></i> Descargar
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const modalAnterior = document.getElementById('modalEstudio');
    if (modalAnterior) {
        modalAnterior.remove();
    }
    
    // Agregar y mostrar modal
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = new bootstrap.Modal(document.getElementById('modalEstudio'));
    modal.show();
    
    // Limpiar al cerrar
    document.getElementById('modalEstudio').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// =============== RECETAS ===============

// Cargar recetas al iniciar
cargarRecetas();

async function cargarRecetas() {
    try {
        const response = await fetch(`/historial/${idHistorial}/recetas`);
        const recetas = await response.json();
        
        const listaRecetas = document.getElementById('listaRecetas');
        
        if (recetas.length === 0) {
            listaRecetas.innerHTML = '<div class="alert alert-secondary"><small>Sin recetas registradas</small></div>';
            return;
        }
        
        listaRecetas.innerHTML = recetas.map(r => `
            <div class="card mb-2" data-id-receta="${r.id_receta}">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="mb-1"><strong>Medicamento:</strong> ${r.medicamento_nombre}</p>
                            <p class="mb-1"><small><strong>Presentación:</strong> ${r.presentacion || 'N/A'}</small></p>
                            <p class="mb-1"><small><strong>Dosis:</strong> ${r.dosis || 'N/A'}</small></p>
                            <p class="mb-1"><small><strong>Frecuencia:</strong> ${r.frecuencia || 'N/A'}</small></p>
                            <p class="mb-1"><small><strong>Duración:</strong> ${r.duracion || 'N/A'}</small></p>
                            ${r.indicaciones ? `<p class="mb-1"><small><strong>Indicaciones:</strong> ${r.indicaciones}</small></p>` : ''}
                            <small class="text-muted">Médico: ${r.nombre_medico} - ${new Date(r.fecha_emision).toLocaleDateString('es-ES')}</small>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-sm btn-primary w-100 mb-1" onclick="editarReceta('${r.id_receta}')">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-danger w-100" onclick="eliminarReceta('${r.id_receta}')">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error al cargar recetas:', error);
        document.getElementById('listaRecetas').innerHTML = '<div class="alert alert-danger"><small>Error al cargar recetas</small></div>';
    }
}

// Agregar receta
document.getElementById('formAgregarReceta').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const medicamento_nombre = document.getElementById('medicamento_nombre').value.trim();
    const presentacion = document.getElementById('presentacion').value.trim();
    const dosis = document.getElementById('dosis').value.trim();
    const frecuencia = document.getElementById('frecuencia').value.trim();
    const duracion = document.getElementById('duracion').value.trim();
    const indicaciones = document.getElementById('indicaciones').value.trim();
    
    try {
        const response = await fetch(`/historial/${idHistorial}/recetas`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                medicamento_nombre,
                presentacion: presentacion || null,
                dosis: dosis || null,
                frecuencia: frecuencia || null,
                duracion: duracion || null,
                indicaciones: indicaciones || null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Receta creada exitosamente');
            document.getElementById('formAgregarReceta').reset();
            cargarRecetas();
        } else {
            alert('Error: ' + data.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al crear receta');
    }
});

async function editarReceta(idReceta) {
    alert('Funcionalidad de edición en desarrollo');
}

async function eliminarReceta(idReceta) {
    if (!confirm('¿Eliminar esta receta?')) return;
    
    try {
        const response = await fetch(`/historial/recetas/${idReceta}/eliminar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Receta eliminada');
            cargarRecetas();
        } else {
            alert('Error: ' + data.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar receta');
    }
}
</script>
