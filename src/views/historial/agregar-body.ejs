<!-- AGREGAR HISTORIAL MÉDICO -->
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-file-medical me-2"></i>Agregar Nuevo Historial Médico</h4>
                </div>
                <div class="card-body p-4">
                    <!-- Paso 1: Buscar Paciente -->
                    <div class="step-section mb-4" id="step1">
                        <h5 class="mb-3">Paso 1: Buscar Paciente</h5>
                        <div class="input-group input-group-lg">
                            <input type="text" 
                                   class="form-control" 
                                   id="searchPaciente" 
                                   placeholder="Buscar por nombre, CI...">
                            <button class="btn btn-primary" type="button" id="btnLimpiarPaciente">
                                <i class="bi bi-x"></i> Limpiar
                            </button>
                        </div>
                        
                        <!-- Dropdown de resultados -->
                        <div id="pacienteResultados" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto; position: absolute; width: 60%; z-index: 1000;"></div>
                        
                        <!-- Paciente seleccionado -->
                        <div id="pacienteSeleccionado" class="alert alert-info mt-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Paciente:</strong> <span id="nombrePaciente"></span></p>
                                    <p><strong>C.I.:</strong> <span id="ciPaciente"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Tipo de Sangre:</strong> <span id="tipoSangrePaciente"></span></p>
                                    <p><strong>Alergias:</strong> <span id="allergiasPaciente" style="color: #dc3545;"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Paso 2: Seleccionar Cita -->
                    <div class="step-section mb-4" id="step2" style="opacity: 0.5; pointer-events: none;">
                        <h5 class="mb-3">Paso 2: Seleccionar Cita</h5>
                        <div id="citasContainer" class="row"></div>
                        <div id="citasVacias" class="alert alert-warning" style="display: none;">
                            Este paciente no tiene citas pendientes para registrar historial.
                        </div>
                    </div>

                    <hr>

                    <!-- Paso 3: Completar Historial -->
                    <div class="step-section" id="step3" style="opacity: 0.5; pointer-events: none;">
                        <h5 class="mb-3">Paso 3: Información del Historial</h5>
                        
                        <form id="formHistorial">
                            <div class="mb-3">
                                <label for="diagnosticos" class="form-label">Diagnósticos</label>
                                <textarea class="form-control" id="diagnosticos" name="diagnosticos" rows="3" placeholder="Describa los diagnósticos..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="evoluciones" class="form-label">Evoluciones</label>
                                <textarea class="form-control" id="evoluciones" name="evoluciones" rows="3" placeholder="Registre la evolución del paciente..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="antecedentes" class="form-label">Antecedentes</label>
                                <textarea class="form-control" id="antecedentes" name="antecedentes" rows="3" placeholder="Antecedentes médicos relevantes..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="tratamientos" class="form-label">Tratamientos</label>
                                <textarea class="form-control" id="tratamientos" name="tratamientos" rows="3" placeholder="Tratamientos recomendados..."></textarea>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success btn-lg" id="btnGuardar">
                                    <i class="bi bi-check-circle me-2"></i>Guardar Historial
                                </button>
                                <button type="reset" class="btn btn-secondary btn-lg">
                                    <i class="bi bi-arrow-counterclockwise me-2"></i>Limpiar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let idPacienteSeleccionado = null;
let idCitaSeleccionada = null;

// Buscar paciente
document.getElementById('searchPaciente').addEventListener('input', async (e) => {
    const query = e.target.value.trim();
    const resultados = document.getElementById('pacienteResultados');
    
    if (query.length < 2) {
        resultados.style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch(`/historial/buscar-paciente?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.length === 0) {
            resultados.innerHTML = '<div class="list-group-item">No hay resultados</div>';
            resultados.style.display = 'block';
            return;
        }
        
        resultados.innerHTML = data.map(p => `
            <button type="button" class="list-group-item list-group-item-action" onclick="seleccionarPaciente('${p.id_paciente}', '${p.nombre_completo}', '${p.ci}', '${p.tipo_sangre || 'N/A'}', '${p.alergias || 'Ninguna'}')">
                <strong>${p.nombre_completo}</strong><br>
                <small>C.I.: ${p.ci}</small>
            </button>
        `).join('');
        resultados.style.display = 'block';
    } catch (error) {
        console.error('Error:', error);
        alert('Error al buscar paciente');
    }
});

function seleccionarPaciente(id, nombre, ci, sangre, alergias) {
    idPacienteSeleccionado = id;
    
    document.getElementById('searchPaciente').value = nombre;
    document.getElementById('pacienteResultados').style.display = 'none';
    
    document.getElementById('nombrePaciente').textContent = nombre;
    document.getElementById('ciPaciente').textContent = ci;
    document.getElementById('tipoSangrePaciente').textContent = sangre;
    document.getElementById('allergiasPaciente').textContent = alergias;
    
    document.getElementById('pacienteSeleccionado').style.display = 'block';
    
    // Habilitar step 2
    document.getElementById('step2').style.opacity = '1';
    document.getElementById('step2').style.pointerEvents = 'auto';
    
    cargarCitas(id);
}

async function cargarCitas(idPaciente) {
    try {
        const response = await fetch(`/historial/citas-sin-historial/${idPaciente}`);
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const citas = await response.json();
        
        const container = document.getElementById('citasContainer');
        const vacio = document.getElementById('citasVacias');
        
        if (!Array.isArray(citas) || citas.length === 0) {
            container.innerHTML = '';
            vacio.style.display = 'block';
            return;
        }
        
        vacio.style.display = 'none';
        container.innerHTML = citas.map(cita => `
            <div class="col-md-6 mb-3">
                <div class="card border-primary cursor-pointer cita-card" onclick="seleccionarCita('${cita.id_cita}', this)" data-id="${cita.id_cita}">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-calendar-event me-2"></i>${new Date(cita.fecha_cita).toLocaleDateString('es-ES')}</h6>
                        <p class="card-text mb-2">
                            <strong>Hora:</strong> ${cita.hora_cita.substring(0, 5)}<br>
                            <strong>Médico:</strong> ${cita.nombre_medico}<br>
                            <strong>Servicio:</strong> ${cita.servicio}<br>
                            <strong>Motivo:</strong> ${cita.motivo_consulta}
                        </p>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error al cargar citas:', error);
        alert('Error al cargar citas: ' + error.message);
    }
}

function seleccionarCita(idCita, elemento) {
    // Remover selección anterior
    document.querySelectorAll('.cita-card').forEach(el => el.classList.remove('border-success', 'bg-light'));
    
    idCitaSeleccionada = idCita;
    elemento.classList.add('border-success', 'bg-light');
    
    // Habilitar step 3
    document.getElementById('step3').style.opacity = '1';
    document.getElementById('step3').style.pointerEvents = 'auto';
    
    // Scroll a step 3
    document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('btnLimpiarPaciente').addEventListener('click', () => {
    document.getElementById('searchPaciente').value = '';
    document.getElementById('pacienteSeleccionado').style.display = 'none';
    document.getElementById('citasContainer').innerHTML = '';
    document.getElementById('citasVacias').style.display = 'none';
    document.getElementById('step2').style.opacity = '0.5';
    document.getElementById('step2').style.pointerEvents = 'none';
    document.getElementById('step3').style.opacity = '0.5';
    document.getElementById('step3').style.pointerEvents = 'none';
    idPacienteSeleccionado = null;
    idCitaSeleccionada = null;
});

// Guardar historial
document.getElementById('formHistorial').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!idPacienteSeleccionado || !idCitaSeleccionada) {
        alert('Por favor complete los pasos anteriores');
        return;
    }
    
    const btn = document.getElementById('btnGuardar');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
    
    try {
        const response = await fetch('/historial/guardar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id_paciente: idPacienteSeleccionado,
                id_cita: idCitaSeleccionada,
                diagnosticos: document.getElementById('diagnosticos').value,
                evoluciones: document.getElementById('evoluciones').value,
                antecedentes: document.getElementById('antecedentes').value,
                tratamientos: document.getElementById('tratamientos').value
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('¡Historial creado exitosamente!');
            // Redirigir a la página de estudios
            window.location.href = `/historial/ver/${data.id_historial}`;
        } else {
            alert('Error: ' + data.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar historial');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Guardar Historial';
    }
});
</script>

<style>
.cita-card {
    transition: all 0.3s ease;
    border: 2px solid #dee2e6 !important;
}

.cita-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.cita-card.border-success {
    border: 2px solid #198754 !important;
    background-color: #f0f9f6 !important;
}
</style>
